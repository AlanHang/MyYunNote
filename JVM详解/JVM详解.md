[TOC]

# 1. JVM和Java体系架构

##  1.1 JVM所处位置

JVM（程序虚拟机）是运行在操作系统之上的，它与硬件没有直接的交互。

![image-20210222192810177](JVM详解.assets/image-20210222192810177.png)

![image-20210222192839539](JVM详解.assets/image-20210222192839539.png)

## 1.2 JVM整体结构

HotSpot VM 采用解释器与即时编译器并存的架构。

![image-20210218144600799](JVM详解.assets/image-20210218144600799.png)

![image-20210223200739276](JVM详解.assets/image-20210223200739276.png)

##  1.3 Java代码执行流程

![image-20210222194046834](JVM详解.assets/image-20210222194046834.png)

## 1.4 JVM的结构模型

Java 编译器输入的指令流基本上是一种基于栈的指令集架构，另外一种指令集架构则是基于寄存器的指令集架构。

具体来说，两种架构之间的区别：

- 基于栈示架构的特点
  - 设计和实现更简单，适用于资源受限的系统。
  - 避开了寄存器的分配难题：使用零地址指令方式分配。
  - 指令流中的指令大部分是零地址指令，其执行过程依赖于操作栈。指令集更小，编译器容易实现。
  - 不需要硬件支持，可移植性更好，更好实现跨平台。
- 基于寄存器架构的特点
  - 典型的应用是X86的二进制指令集：比如传统的PC以及安卓的Davlik虚拟机。
  - 指令集架构则完全依赖硬件，可移植性差。
  - 性能优秀、执行更高效。
  - 花费更少的指令去完成一项操作。
  - 大部分情况下，基于寄存器架构的指令集往往都以一地址指令，二地址指令和三地址指令为主，而基于栈式架构的指令集却是以零地址为主。

```
Java 反编译命令 javap -v xxx.class
```

## 1.5 JVM的生命周期

**JVM虚拟机启动**

Java虚拟机的启动时通过引导类加载器（bootstrap class loader ）创建的一个初始类（initial class）来完成的，这个类是由虚拟机的具体实现指定的。

**虚拟机的执行**

- 一个运行中的Java虚拟机有着一个清晰的任务：执行Java程序。
- 程序开始执行时他才运行，程序结束时他就停止。
- ==执行一个所谓的Java程序的时候，真真正正在执行的是一个叫Java虚拟机的进程。==

**虚拟机的退出**

有如下几种情况：

- 程序正常执行结束。
- 程序在执行过程中遇到了异常或错误而异常终止。
- 由于操作系统出现错误而导致Java虚拟机进程终止。
- 某线程调用Runtime类或System类的exit方法，或Runtime类的halt方法，并且Java安全管理器也允许这次exit或者halt操作。
- 除此之外，JNI规范中描述了用JNI Invocation API来加载或卸载Java虚拟机时，Java虚拟机退出的情况。

## 1.6 虚拟机发展史

**Sun Classic VM**

![image-20210223192227313](JVM详解.assets/image-20210223192227313.png)

**Exact VM**

![image-20210223192249005](JVM详解.assets/image-20210223192249005.png)

**HotSpot VM**

![image-20210223192420990](JVM详解.assets/image-20210223192420990.png)

**JRockit**

![image-20210223192645086](JVM详解.assets/image-20210223192645086.png)

**J9**

![image-20210223193021123](JVM详解.assets/image-20210223193021123.png)

# 2.类加载子系统（Class Loader System）

**类加载器子系统作用**

![image-20210223201122041.png](JVM详解.assets/image-20210223201122041.png)

**类加载器的角色**

![image-20210223201543571](JVM详解.assets/image-20210223201543571.png)

